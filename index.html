<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ê³µë¶€ íƒ€ì´ë¨¸">
  <meta name="theme-color" content="#0F0F1A">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>ê³µë¶€ íƒ€ì´ë¨¸</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg-primary: #0F0F1A;
      --bg-secondary: #1A1A2E;
      --bg-tertiary: #16213E;
      --accent: #6C63FF;
      --accent-light: #8B83FF;
      --running: #00C9A7;
      --paused: #FFB800;
      --stopped: #FF6B6B;
      --text-primary: #E8E8E8;
      --text-secondary: #A0A0B0;
      --border: #2A2A40;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ===== Tab Screens ===== */
    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow-y: auto;
      padding-top: calc(var(--safe-top) + 12px);
      padding-bottom: 100px;
    }
    .screen.active { display: flex; }

    /* ===== Tab Bar ===== */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding-bottom: var(--safe-bottom);
      z-index: 100;
    }
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0 8px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: color 0.2s;
      border: none;
      background: none;
    }
    .tab.active { color: var(--accent); }
    .tab svg { width: 24px; height: 24px; margin-bottom: 2px; }

    /* ===== Timer Screen ===== */
    .timer-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 24px;
    }

    .task-input {
      width: 100%;
      max-width: 340px;
      font-size: 18px;
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 20px;
      text-align: center;
      outline: none;
      transition: border-color 0.2s;
    }
    .task-input:focus { border-color: var(--accent); }
    .task-input::placeholder { color: var(--text-secondary); }

    .task-label {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .timer-display {
      font-size: 64px;
      font-weight: 300;
      font-variant-numeric: tabular-nums;
      letter-spacing: 2px;
      margin: 28px 0;
      transition: color 0.3s;
    }
    .timer-display.running { color: var(--running); }
    .timer-display.paused { color: var(--paused); animation: pulse 1.5s ease-in-out infinite; }
    .timer-display.idle { color: var(--text-primary); opacity: 0.4; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .paused-label {
      font-size: 14px;
      color: var(--paused);
      font-weight: 500;
      margin-top: -16px;
      margin-bottom: 16px;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 32px;
      border-radius: 14px;
      border: none;
      font-size: 17px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      min-width: 130px;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    .btn:disabled { opacity: 0.35; cursor: default; }
    .btn-start { background: var(--accent); min-width: 180px; }
    .btn-pause { background: var(--paused); }
    .btn-resume { background: var(--running); }
    .btn-stop { background: var(--stopped); }

    .daily-banner {
      width: 100%;
      max-width: 340px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 32px;
    }
    .daily-banner .label { font-size: 14px; color: var(--text-secondary); }
    .daily-banner .value { font-size: 16px; font-weight: 700; color: var(--accent); }

    /* ===== Today Screen ===== */
    .today-screen { padding: 16px 0; }

    .total-banner-large {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 24px;
      margin: 0 20px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .total-banner-large .label { font-size: 17px; color: var(--text-secondary); }
    .total-banner-large .value { font-size: 24px; font-weight: 700; color: var(--accent); }

    .section-title {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 600;
      padding: 4px 24px 12px;
    }

    .session-card {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      margin: 0 20px 8px;
    }
    .session-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      flex-shrink: 0;
    }
    .session-icon svg { width: 18px; height: 18px; color: var(--accent); }
    .session-info { flex: 1; }
    .session-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
    .session-time { font-size: 12px; color: var(--text-secondary); }
    .session-duration { font-size: 15px; font-weight: 700; color: var(--accent); margin-left: 12px; }

    .empty-state {
      text-align: center;
      padding-top: 60px;
      color: var(--text-secondary);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state .msg { font-size: 16px; margin-bottom: 4px; }
    .empty-state .sub { font-size: 13px; opacity: 0.7; }

    /* ===== History Screen ===== */
    .history-screen { padding: 16px 0; }

    .stats-toggle {
      display: flex;
      margin: 0 20px 16px;
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 3px;
      border: 1px solid var(--border);
    }
    .stats-toggle button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .stats-toggle button.active {
      background: var(--accent);
      color: #fff;
    }

    .stats-summary {
      display: flex;
      gap: 10px;
      margin: 0 20px 16px;
    }
    .stat-card {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
    }
    .stat-card .stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .stat-card .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
    .stat-card .stat-sub { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }

    .chart-container {
      margin: 0 20px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 12px 12px;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 12px;
      padding-left: 4px;
    }
    .chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 120px;
      padding-bottom: 24px;
      position: relative;
    }
    .chart-bar-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: flex-end;
    }
    .chart-bar {
      width: 100%;
      max-width: 32px;
      border-radius: 6px 6px 2px 2px;
      background: var(--accent);
      min-height: 2px;
      transition: height 0.3s ease;
      position: relative;
    }
    .chart-bar.today-bar { background: var(--running); }
    .chart-bar-value {
      font-size: 9px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .chart-bar-label {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    .history-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 8px 24px 12px;
    }

    .date-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px 10px;
    }
    .date-header .date { font-size: 16px; font-weight: 700; }
    .date-header .total { font-size: 14px; font-weight: 600; color: var(--accent); }

    /* ===== Session delete ===== */
    .session-card { position: relative; }
    .session-delete {
      position: absolute;
      right: 8px;
      top: 8px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      opacity: 0.5;
    }
    .session-delete:hover { opacity: 1; color: var(--stopped); }

    /* ===== Reset button ===== */
    .reset-section {
      margin: 24px 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .btn-reset {
      width: 100%;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid var(--stopped);
      background: none;
      color: var(--stopped);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-reset:active { background: var(--stopped); color: #fff; }

    /* ===== Confirm modal ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg-secondary);
      border-radius: 16px;
      padding: 24px;
      width: 280px;
      text-align: center;
    }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
    .modal-msg { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 10px; }
    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .modal-cancel { background: var(--bg-tertiary); color: var(--text-primary); }
    .modal-confirm { background: var(--stopped); color: #fff; }
  </style>
</head>
<body>

  <!-- Timer Screen -->
  <div id="screen-timer" class="screen active">
    <div class="timer-screen">
      <div id="task-input-area">
        <input type="text" id="taskInput" class="task-input" placeholder="ë¬´ì—‡ì„ ê³µë¶€í• ê¹Œìš”?" autocomplete="off">
      </div>
      <div id="task-label-area" style="display:none">
        <div class="task-label" id="taskLabel"></div>
      </div>

      <div id="timerDisplay" class="timer-display idle">00:00:00</div>
      <div id="pausedLabel" class="paused-label" style="display:none">ì¼ì‹œì •ì§€</div>

      <div class="controls" id="controls-idle">
        <button class="btn btn-start" id="btnStart" disabled>â–¶ ì‹œì‘</button>
      </div>
      <div class="controls" id="controls-running" style="display:none">
        <button class="btn btn-pause" id="btnPause">â¸ ì¼ì‹œì •ì§€</button>
        <button class="btn btn-stop" id="btnStop1">â¹ ì¢…ë£Œ</button>
      </div>
      <div class="controls" id="controls-paused" style="display:none">
        <button class="btn btn-resume" id="btnResume">â–¶ ì¬ê°œ</button>
        <button class="btn btn-stop" id="btnStop2">â¹ ì¢…ë£Œ</button>
      </div>

      <div class="daily-banner">
        <span class="label">ì˜¤ëŠ˜ ì´ ê³µë¶€</span>
        <span class="value" id="miniTotal">0ë¶„</span>
      </div>
      <div style="margin-top:16px;font-size:11px;color:#555;">v6.1</div>
    </div>
  </div>

  <!-- Today Screen -->
  <div id="screen-today" class="screen">
    <div class="today-screen">
      <div class="total-banner-large">
        <span class="label">ì˜¤ëŠ˜ ì´ ê³µë¶€</span>
        <span class="value" id="todayTotal">0ë¶„</span>
      </div>
      <div id="todaySessionCount" class="section-title"></div>
      <div id="todayList"></div>
      <div id="todayEmpty" class="empty-state" style="display:none">
        <div class="icon">ğŸ“š</div>
        <div class="msg">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”</div>
        <div class="sub">íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
      </div>

      <div class="reset-section" id="todayResetSection" style="display:none">
        <button class="btn-reset" onclick="showResetModal('today')">ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- History Screen -->
  <div id="screen-history" class="screen">
    <div class="history-screen">
      <!-- ì£¼ê°„/ì›”ê°„ í† ê¸€ -->
      <div class="stats-toggle">
        <button id="toggleWeek" class="active" onclick="setStatsView('week')">ì´ë²ˆ ì£¼</button>
        <button id="toggleMonth" onclick="setStatsView('month')">ì´ë²ˆ ë‹¬</button>
      </div>

      <!-- í†µê³„ ì¹´ë“œ -->
      <div class="stats-summary">
        <div class="stat-card">
          <div class="stat-label" id="statPeriodLabel">ì´ë²ˆ ì£¼ ì´</div>
          <div class="stat-value" id="statTotal">0ë¶„</div>
          <div class="stat-sub" id="statDays">0ì¼ ê³µë¶€</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ì¼ í‰ê· </div>
          <div class="stat-value" id="statAvg">0ë¶„</div>
          <div class="stat-sub" id="statSessions">0ê°œ ì„¸ì…˜</div>
        </div>
      </div>

      <!-- ë§‰ëŒ€ ê·¸ë˜í”„ -->
      <div class="chart-container">
        <div class="chart-title" id="chartTitle">ì¼ë³„ ê³µë¶€ ì‹œê°„</div>
        <div class="chart" id="chartBars"></div>
      </div>

      <!-- ë‚ ì§œë³„ ê¸°ë¡ -->
      <div class="history-section-title" id="historyDetailTitle">ìƒì„¸ ê¸°ë¡</div>
      <div id="historyList"></div>
      <div id="historyEmpty" class="empty-state" style="display:none">
        <div class="icon">ğŸ“…</div>
        <div class="msg">ê¸°ë¡ì´ ì—†ì–´ìš”</div>
        <div class="sub">ê³µë¶€ë¥¼ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— ê¸°ë¡ë©ë‹ˆë‹¤</div>
      </div>

      <div class="reset-section" id="historyResetSection" style="display:none">
        <button class="btn-reset" onclick="showResetModal('all')">ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="resetModal">
    <div class="modal">
      <div class="modal-title" id="modalTitle">ê¸°ë¡ ì´ˆê¸°í™”</div>
      <div class="modal-msg" id="modalMsg">ì •ë§ ì‚­ì œí• ê¹Œìš”? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" onclick="closeResetModal()">ì·¨ì†Œ</button>
        <button class="modal-btn modal-confirm" id="modalConfirm">ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <button class="tab active" data-screen="timer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
      íƒ€ì´ë¨¸
    </button>
    <button class="tab" data-screen="today">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01"/>
      </svg>
      ì˜¤ëŠ˜
    </button>
    <button class="tab" data-screen="history">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      ê¸°ë¡
    </button>
  </nav>

  <script>
    // ===== Storage =====
    const KEYS = {
      TIMER: 'study_timer_state',
      daily: (d) => `study_daily_${d}`,
      ALL_DATES: 'study_all_dates',
    };

    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function load(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }

    // ===== Time Utils =====
    function pad(n) { return n.toString().padStart(2, '0'); }
    function formatDuration(ms) {
      const s = Math.floor(ms / 1000);
      return `${pad(Math.floor(s / 3600))}:${pad(Math.floor((s % 3600) / 60))}:${pad(s % 60)}`;
    }
    function formatShort(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return `${h}ì‹œê°„ ${m}ë¶„`;
      if (m > 0) return `${m}ë¶„ ${s}ì´ˆ`;
      return `${s}ì´ˆ`;
    }
    function formatTime(iso) {
      const d = new Date(iso);
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function todayStr() {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function formatDateHeader(ds) {
      const d = new Date(ds + 'T00:00:00');
      const weekdays = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      return `${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${weekdays[d.getDay()]})`;
    }

    // ===== State =====
    const DEFAULT_STATE = { status: 'idle', taskName: '', segmentStartedAt: null, accumulatedMs: 0, sessionStartedAt: null };
    let state = load(KEYS.TIMER) || { ...DEFAULT_STATE };
    let tickInterval = null;

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);
    const taskInput = $('taskInput');
    const taskInputArea = $('task-input-area');
    const taskLabelArea = $('task-label-area');
    const taskLabel = $('taskLabel');
    const timerDisplay = $('timerDisplay');
    const pausedLabel = $('pausedLabel');
    const controlsIdle = $('controls-idle');
    const controlsRunning = $('controls-running');
    const controlsPaused = $('controls-paused');
    const btnStart = $('btnStart');
    const miniTotal = $('miniTotal');

    // ===== Timer Logic =====
    function computeElapsed() {
      if (state.status === 'running' && state.segmentStartedAt) {
        return state.accumulatedMs + (Date.now() - new Date(state.segmentStartedAt).getTime());
      }
      return state.accumulatedMs;
    }

    function persistState() { save(KEYS.TIMER, state); }

    function startTimer() {
      const name = taskInput.value.trim();
      if (!name) return;
      const now = new Date().toISOString();
      state = { status: 'running', taskName: name, segmentStartedAt: now, accumulatedMs: 0, sessionStartedAt: now };
      persistState();
      updateUI();
      startTick();
    }

    function pauseTimer() {
      state.accumulatedMs = computeElapsed();
      state.status = 'paused';
      state.segmentStartedAt = null;
      persistState();
      stopTick();
      updateUI();
    }

    function resumeTimer() {
      state.status = 'running';
      state.segmentStartedAt = new Date().toISOString();
      persistState();
      updateUI();
      startTick();
    }

    function stopTimer() {
      const elapsed = computeElapsed();
      const taskName = state.taskName;
      const sessionStart = state.sessionStartedAt;

      // ì„¸ì…˜ ì €ì¥
      if (elapsed > 0 && sessionStart) {
        const session = {
          id: Date.now().toString(),
          taskName: taskName,
          startedAt: sessionStart,
          endedAt: new Date().toISOString(),
          durationMs: elapsed,
        };
        saveSession(session);
      }

      // ìƒíƒœ ì´ˆê¸°í™”
      state = { ...DEFAULT_STATE };
      persistState();
      stopTick();
      taskInput.value = '';
      updateUI();
      updateTodayScreen();
      updateHistoryScreen();
    }

    function startTick() {
      stopTick();
      tickInterval = setInterval(() => {
        timerDisplay.textContent = formatDuration(computeElapsed());
        updateMiniTotal();
      }, 100);
    }

    function stopTick() {
      if (tickInterval) { clearInterval(tickInterval); tickInterval = null; }
    }

    // ===== Session Storage =====
    function localDateStr(isoStr) {
      const d = new Date(isoStr);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function saveSession(session) {
      try {
        const date = localDateStr(session.startedAt);
        const key = KEYS.daily(date);
        const record = load(key) || { date: date, sessions: [], totalDurationMs: 0 };
        record.sessions.push(session);
        record.totalDurationMs += session.durationMs;
        save(key, record);

        const dates = load(KEYS.ALL_DATES) || [];
        if (!dates.includes(date)) {
          dates.push(date);
          dates.sort().reverse();
          save(KEYS.ALL_DATES, dates);
        }
      } catch (e) {
        alert('ì €ì¥ ì˜¤ë¥˜: ' + e.message);
      }
    }

    function getTodayRecord() {
      return load(KEYS.daily(todayStr())) || { date: todayStr(), sessions: [], totalDurationMs: 0 };
    }

    function deleteSession(date, sessionId) {
      const key = KEYS.daily(date);
      const record = load(key);
      if (!record) return;

      const idx = record.sessions.findIndex(s => s.id === sessionId);
      if (idx === -1) return;

      record.totalDurationMs -= record.sessions[idx].durationMs;
      record.sessions.splice(idx, 1);

      if (record.sessions.length === 0) {
        localStorage.removeItem(key);
        const dates = (load(KEYS.ALL_DATES) || []).filter(d => d !== date);
        save(KEYS.ALL_DATES, dates);
      } else {
        save(key, record);
      }
    }

    // ===== UI Update =====
    function updateUI() {
      // Timer screen
      if (state.status === 'idle') {
        taskInputArea.style.display = '';
        taskLabelArea.style.display = 'none';
        timerDisplay.className = 'timer-display idle';
        timerDisplay.textContent = '00:00:00';
        pausedLabel.style.display = 'none';
        controlsIdle.style.display = 'flex';
        controlsRunning.style.display = 'none';
        controlsPaused.style.display = 'none';
      } else if (state.status === 'running') {
        taskInputArea.style.display = 'none';
        taskLabelArea.style.display = '';
        taskLabel.textContent = state.taskName;
        timerDisplay.className = 'timer-display running';
        timerDisplay.textContent = formatDuration(computeElapsed());
        pausedLabel.style.display = 'none';
        controlsIdle.style.display = 'none';
        controlsRunning.style.display = 'flex';
        controlsPaused.style.display = 'none';
      } else {
        taskInputArea.style.display = 'none';
        taskLabelArea.style.display = '';
        taskLabel.textContent = state.taskName;
        timerDisplay.className = 'timer-display paused';
        timerDisplay.textContent = formatDuration(computeElapsed());
        pausedLabel.style.display = '';
        controlsIdle.style.display = 'none';
        controlsRunning.style.display = 'none';
        controlsPaused.style.display = 'flex';
      }
      updateMiniTotal();
    }

    function updateMiniTotal() {
      const rec = getTodayRecord();
      let total = rec.totalDurationMs;
      if (state.status !== 'idle') total += computeElapsed();
      miniTotal.textContent = total > 0 ? formatShort(total) : '0ë¶„';
    }

    function renderSessionCard(session, showDelete = false) {
      const date = localDateStr(session.startedAt);
      return `<div class="session-card" data-id="${session.id}">
        <div class="session-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        </div>
        <div class="session-info">
          <div class="session-name">${session.taskName}</div>
          <div class="session-time">${formatTime(session.startedAt)} - ${formatTime(session.endedAt)}</div>
        </div>
        <div class="session-duration">${formatShort(session.durationMs)}</div>
        <button class="session-delete" onclick="onDeleteSession('${date}','${session.id}')" title="ì‚­ì œ">âœ•</button>
      </div>`;
    }

    function onDeleteSession(date, sessionId) {
      if (!confirm('ì´ ì„¸ì…˜ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      deleteSession(date, sessionId);
      updateUI();
      updateTodayScreen();
      updateHistoryScreen();
    }

    function updateTodayScreen() {
      const rec = getTodayRecord();
      let total = rec.totalDurationMs;
      if (state.status !== 'idle') total += computeElapsed();
      $('todayTotal').textContent = total > 0 ? formatShort(total) : '0ë¶„';

      const sessions = [...rec.sessions].reverse();
      if (sessions.length === 0) {
        $('todaySessionCount').textContent = '';
        $('todayList').innerHTML = '';
        $('todayEmpty').style.display = '';
        $('todayResetSection').style.display = 'none';
      } else {
        $('todaySessionCount').textContent = `ì˜¤ëŠ˜ì˜ ì„¸ì…˜ (${sessions.length}ê°œ)`;
        $('todayList').innerHTML = sessions.map(renderSessionCard).join('');
        $('todayEmpty').style.display = 'none';
        $('todayResetSection').style.display = '';
      }
    }

    // ===== Stats & Chart =====
    let currentStatsView = 'week';

    function setStatsView(view) {
      currentStatsView = view;
      $('toggleWeek').classList.toggle('active', view === 'week');
      $('toggleMonth').classList.toggle('active', view === 'month');
      updateHistoryScreen();
    }

    function getDateRange(view) {
      const today = new Date();
      const dates = [];
      if (view === 'week') {
        const day = today.getDay(); // 0=ì¼ 1=ì›”...
        const monday = new Date(today);
        monday.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
        for (let i = 0; i < 7; i++) {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          dates.push(formatDateStr(d));
        }
      } else {
        const year = today.getFullYear();
        const month = today.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
          dates.push(formatDateStr(new Date(year, month, i)));
        }
      }
      return dates;
    }

    function formatDateStr(d) {
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function getShortLabel(dateStr, view) {
      const d = new Date(dateStr + 'T00:00:00');
      if (view === 'week') {
        return ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()];
      }
      return d.getDate().toString();
    }

    function formatHours(ms) {
      const h = ms / 3600000;
      if (h >= 1) return h.toFixed(1) + 'h';
      const m = Math.floor(ms / 60000);
      return m + 'm';
    }

    function updateHistoryScreen() {
      const allDates = load(KEYS.ALL_DATES) || [];
      const rangeDates = getDateRange(currentStatsView);
      const todayDate = todayStr();

      // ê¸°ê°„ ë‚´ ë°ì´í„° ìˆ˜ì§‘
      let totalMs = 0;
      let totalSessions = 0;
      let studyDays = 0;
      const dailyData = [];

      for (const date of rangeDates) {
        const rec = load(KEYS.daily(date));
        const ms = rec ? rec.totalDurationMs : 0;
        const sessions = rec ? rec.sessions.length : 0;
        dailyData.push({ date, ms, sessions });
        totalMs += ms;
        totalSessions += sessions;
        if (ms > 0) studyDays++;
      }

      // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
      $('statPeriodLabel').textContent = currentStatsView === 'week' ? 'ì´ë²ˆ ì£¼ ì´' : 'ì´ë²ˆ ë‹¬ ì´';
      $('statTotal').textContent = totalMs > 0 ? formatShort(totalMs) : '0ë¶„';
      $('statDays').textContent = `${studyDays}ì¼ ê³µë¶€`;
      $('statAvg').textContent = studyDays > 0 ? formatShort(Math.floor(totalMs / studyDays)) : '0ë¶„';
      $('statSessions').textContent = `${totalSessions}ê°œ ì„¸ì…˜`;

      // ë§‰ëŒ€ ê·¸ë˜í”„
      const maxMs = Math.max(...dailyData.map(d => d.ms), 1);
      const totalBars = dailyData.length;
      // ë¼ë²¨ ê°„ê²©: 7ê°œ ì´í•˜ë©´ ì „ë¶€ í‘œì‹œ, ê·¸ ì´ìƒì´ë©´ 5ì¼ ê°„ê²©
      const labelStep = totalBars <= 7 ? 1 : 5;
      let chartHtml = '';
      for (let i = 0; i < dailyData.length; i++) {
        const d = dailyData[i];
        const heightPct = (d.ms / maxMs) * 100;
        const isToday = d.date === todayDate;
        const valueLabel = d.ms > 0 ? formatHours(d.ms) : '';
        // ì²«ë‚ , ë§ˆì§€ë§‰ë‚ , ì˜¤ëŠ˜, ê·¸ë¦¬ê³  ê°„ê²©ì— ë§ëŠ” ë‚ ë§Œ ë¼ë²¨ í‘œì‹œ
        const dayNum = new Date(d.date + 'T00:00:00').getDate();
        const showLabel = totalBars <= 7 || dayNum === 1 || i === totalBars - 1 || isToday || dayNum % labelStep === 0;
        const label = showLabel ? getShortLabel(d.date, currentStatsView) : '';
        chartHtml += `<div class="chart-bar-wrap">
          <div class="chart-bar-value">${valueLabel}</div>
          <div class="chart-bar ${isToday ? 'today-bar' : ''}" style="height: ${Math.max(heightPct, d.ms > 0 ? 3 : 0)}%"></div>
          <div class="chart-bar-label">${label}</div>
        </div>`;
      }
      $('chartBars').innerHTML = chartHtml;
      $('chartTitle').textContent = currentStatsView === 'week' ? 'ì¼ë³„ ê³µë¶€ ì‹œê°„ (ì´ë²ˆ ì£¼)' : 'ì¼ë³„ ê³µë¶€ ì‹œê°„ (ì´ë²ˆ ë‹¬)';

      // ìƒì„¸ ê¸°ë¡ (ë‚ ì§œë³„)
      if (allDates.length === 0) {
        $('historyList').innerHTML = '';
        $('historyEmpty').style.display = '';
        $('historyDetailTitle').style.display = 'none';
        $('historyResetSection').style.display = 'none';
        return;
      }
      $('historyEmpty').style.display = 'none';
      $('historyDetailTitle').style.display = '';
      $('historyResetSection').style.display = '';
      let html = '';
      for (const date of allDates) {
        const rec = load(KEYS.daily(date));
        if (!rec || rec.sessions.length === 0) continue;
        html += `<div class="date-header">
          <span class="date">${formatDateHeader(date)}</span>
          <span class="total">${formatShort(rec.totalDurationMs)}</span>
        </div>`;
        const sessions = [...rec.sessions].reverse();
        html += sessions.map(renderSessionCard).join('');
      }
      $('historyList').innerHTML = html;
    }

    // ===== Reset Functions =====
    let pendingResetType = null;

    function showResetModal(type) {
      pendingResetType = type;
      if (type === 'today') {
        $('modalTitle').textContent = 'ì˜¤ëŠ˜ ê¸°ë¡ ì´ˆê¸°í™”';
        $('modalMsg').textContent = 'ì˜¤ëŠ˜ì˜ ëª¨ë“  ê³µë¶€ ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      } else {
        $('modalTitle').textContent = 'ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”';
        $('modalMsg').textContent = 'ëª¨ë“  ë‚ ì§œì˜ ê³µë¶€ ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      }
      $('resetModal').classList.add('show');
    }

    function closeResetModal() {
      $('resetModal').classList.remove('show');
      pendingResetType = null;
    }

    $('modalConfirm').addEventListener('click', () => {
      if (pendingResetType === 'today') {
        const today = todayStr();
        localStorage.removeItem(KEYS.daily(today));
        const dates = (load(KEYS.ALL_DATES) || []).filter(d => d !== today);
        save(KEYS.ALL_DATES, dates);
      } else if (pendingResetType === 'all') {
        const dates = load(KEYS.ALL_DATES) || [];
        for (const d of dates) localStorage.removeItem(KEYS.daily(d));
        localStorage.removeItem(KEYS.ALL_DATES);
      }
      closeResetModal();
      updateUI();
      updateTodayScreen();
      updateHistoryScreen();
    });

    $('resetModal').addEventListener('click', (e) => {
      if (e.target === $('resetModal')) closeResetModal();
    });

    // ===== Tab Navigation =====
    const tabs = document.querySelectorAll('.tab');
    const screens = document.querySelectorAll('.screen');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.screen;
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        screens.forEach(s => s.classList.remove('active'));
        $(`screen-${target}`).classList.add('active');

        if (target === 'today') updateTodayScreen();
        if (target === 'history') updateHistoryScreen();
      });
    });

    // ===== Event Listeners =====
    taskInput.addEventListener('input', () => {
      btnStart.disabled = !taskInput.value.trim();
    });
    taskInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && taskInput.value.trim()) startTimer();
    });
    btnStart.addEventListener('click', startTimer);
    $('btnPause').addEventListener('click', pauseTimer);
    $('btnResume').addEventListener('click', resumeTimer);
    $('btnStop1').addEventListener('click', stopTimer);
    $('btnStop2').addEventListener('click', stopTimer);

    // ===== Visibility Change (background/foreground) =====
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && state.status === 'running') {
        timerDisplay.textContent = formatDuration(computeElapsed());
        updateMiniTotal();
      }
    });

    // ===== Init =====
    if (state.status !== 'idle') {
      taskInput.value = state.taskName;
    }
    updateUI();
    if (state.status === 'running') startTick();

    // Service Worker ì™„ì „ ì œê±° (ìºì‹œ ë¬¸ì œ í•´ê²°)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => {
        regs.forEach(r => r.unregister());
      });
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
  </script>
</body>
</html>
