<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="True North">
  <meta name="theme-color" content="#0A0A12">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>True North</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --bg-primary: #0A0A12;
      --bg-secondary: #141420;
      --bg-tertiary: #1C1C2E;
      --accent: #7C6FFF;
      --accent-glow: rgba(124, 111, 255, 0.15);
      --running: #A8A0FF;
      --running-glow: rgba(168, 160, 255, 0.12);
      --paused: #7B8AB8;
      --stopped: #9B7A7A;
      --text-primary: #EAEAF0;
      --text-secondary: #6E6E82;
      --text-tertiary: #3E3E52;
      --border: #1E1E30;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ===== Brand Header ===== */
    .brand-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: calc(var(--safe-top) + 12px) 24px 10px;
      z-index: 50;
      background: linear-gradient(to bottom, var(--bg-primary) 60%, transparent);
    }
    .brand-name {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 1.5px;
      color: var(--text-primary);
    }

    /* ===== Tab Screens ===== */
    .screen {
      display: none;
      flex: 1;
      flex-direction: column;
      overflow-y: auto;
      padding-top: calc(var(--safe-top) + 52px);
      padding-bottom: 100px;
    }
    .screen.active { display: flex; }

    /* ===== Tab Bar ===== */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding-bottom: var(--safe-bottom);
      z-index: 100;
    }
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 0 8px;
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: pointer;
      transition: color 0.2s;
      border: none;
      background: none;
    }
    .tab.active { color: var(--accent); }
    .tab svg { width: 22px; height: 22px; margin-bottom: 3px; }

    /* ===== Timer Screen ===== */
    .timer-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      padding: 24px;
    }

    .task-input {
      width: 100%;
      max-width: 320px;
      font-size: 16px;
      color: var(--text-primary);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 15px 20px;
      text-align: center;
      outline: none;
      transition: border-color 0.3s, box-shadow 0.3s;
      letter-spacing: 0.3px;
    }
    .task-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .task-input::placeholder { color: var(--text-tertiary); font-weight: 400; }

    .task-label {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      letter-spacing: 0.3px;
    }

    .timer-display {
      font-size: 60px;
      font-weight: 200;
      font-variant-numeric: tabular-nums;
      letter-spacing: 3px;
      margin: 32px 0;
      transition: color 0.3s, text-shadow 0.3s;
    }
    .timer-display.running {
      color: var(--running);
      text-shadow: 0 0 40px var(--running-glow);
    }
    .timer-display.paused {
      color: var(--paused);
      animation: pulse 2s ease-in-out infinite;
    }
    .timer-display.idle { color: var(--text-tertiary); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .paused-label {
      font-size: 12px;
      color: var(--paused);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: -20px;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 14px 28px;
      border-radius: 14px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      min-width: 120px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: transform 0.1s, opacity 0.2s;
    }
    .btn:active { transform: scale(0.96); }
    .btn:disabled { opacity: 0.25; cursor: default; }
    .btn-start { background: var(--accent); min-width: 180px; }
    .btn-pause { background: var(--paused); }
    .btn-resume { background: var(--running); }
    .btn-stop { background: var(--stopped); }

    .daily-banner {
      width: 100%;
      max-width: 320px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 36px;
    }
    .daily-banner .label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .daily-banner .value { font-size: 16px; font-weight: 700; color: var(--accent); }

    /* ===== Today Screen ===== */
    .today-screen { padding: 16px 0; }

    .total-banner-large {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 22px 24px;
      margin: 0 20px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .total-banner-large .label { font-size: 15px; color: var(--text-secondary); font-weight: 500; }
    .total-banner-large .value { font-size: 24px; font-weight: 700; color: var(--accent); }

    .section-title {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 24px 12px;
    }

    .session-card {
      display: flex;
      align-items: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 16px;
      margin: 0 20px 8px;
      position: relative;
    }
    .session-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
      flex-shrink: 0;
    }
    .session-icon svg { width: 16px; height: 16px; color: var(--accent); }
    .session-info { flex: 1; }
    .session-name { font-size: 14px; font-weight: 600; margin-bottom: 2px; letter-spacing: 0.2px; }
    .session-time { font-size: 11px; color: var(--text-secondary); }
    .session-duration { font-size: 14px; font-weight: 700; color: var(--accent); margin-left: 12px; }

    .empty-state {
      text-align: center;
      padding-top: 60px;
      color: var(--text-secondary);
    }
    .empty-state .icon { font-size: 40px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state .msg { font-size: 15px; margin-bottom: 4px; font-weight: 500; }
    .empty-state .sub { font-size: 12px; color: var(--text-tertiary); }

    /* ===== History Screen ===== */
    .history-screen { padding: 16px 0; }

    .stats-toggle {
      display: flex;
      margin: 0 20px 16px;
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 3px;
      border: 1px solid var(--border);
    }
    .stats-toggle button {
      flex: 1;
      padding: 9px;
      border: none;
      border-radius: 10px;
      background: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .stats-toggle button.active {
      background: var(--accent);
      color: #fff;
    }

    .stats-summary {
      display: flex;
      gap: 10px;
      margin: 0 20px 16px;
    }
    .stat-card {
      flex: 1;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
    }
    .stat-card .stat-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 500; }
    .stat-card .stat-value { font-size: 20px; font-weight: 700; color: var(--accent); }
    .stat-card .stat-sub { font-size: 11px; color: var(--text-tertiary); margin-top: 4px; }

    .chart-container {
      margin: 0 20px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px 14px 14px;
    }
    .chart-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 14px;
      padding-left: 4px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }
    .chart {
      display: flex;
      align-items: flex-end;
      gap: 3px;
      height: 120px;
      padding-bottom: 24px;
      position: relative;
    }
    .chart-bar-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: flex-end;
    }
    .chart-bar {
      width: 100%;
      max-width: 28px;
      border-radius: 6px 6px 2px 2px;
      background: var(--accent);
      min-height: 2px;
      transition: height 0.3s ease;
      position: relative;
    }
    .chart-bar.today-bar {
      background: var(--running);
      box-shadow: 0 0 12px var(--running-glow);
    }
    .chart-bar-value {
      font-size: 8px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      white-space: nowrap;
    }
    .chart-bar-label {
      font-size: 9px;
      color: var(--text-tertiary);
      margin-top: 6px;
      font-weight: 500;
    }

    .history-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 8px 24px 12px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .date-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px 10px;
    }
    .date-header .date { font-size: 15px; font-weight: 700; letter-spacing: 0.2px; }
    .date-header .total { font-size: 14px; font-weight: 600; color: var(--accent); }

    /* ===== Session delete ===== */
    .session-delete {
      position: absolute;
      right: 8px;
      top: 8px;
      background: none;
      border: none;
      color: var(--text-tertiary);
      font-size: 14px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 6px;
      opacity: 0.6;
      transition: opacity 0.2s, color 0.2s;
    }
    .session-delete:hover { opacity: 1; color: var(--stopped); }

    /* ===== Reset button ===== */
    .reset-section {
      margin: 24px 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .btn-reset {
      width: 100%;
      padding: 13px;
      border-radius: 12px;
      border: 1px solid rgba(155, 122, 122, 0.4);
      background: none;
      color: var(--stopped);
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-reset:active { background: var(--stopped); color: #fff; }

    /* ===== Confirm modal ===== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      z-index: 200;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px 24px 24px;
      width: 280px;
      text-align: center;
    }
    .modal-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
    .modal-msg { font-size: 13px; color: var(--text-secondary); margin-bottom: 22px; line-height: 1.5; }
    .modal-buttons { display: flex; gap: 10px; }
    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.3px;
    }
    .modal-cancel { background: var(--bg-tertiary); color: var(--text-primary); }
    .modal-confirm { background: var(--stopped); color: #fff; }

    /* ===== Suggestion Dropdown ===== */
    .input-wrap {
      position: relative;
      width: 100%;
      max-width: 320px;
    }
    .suggestions {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      z-index: 60;
      max-height: 240px;
      overflow-y: auto;
    }
    .suggestions.show { display: block; }
    .suggestion-item {
      padding: 13px 20px;
      font-size: 15px;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .suggestion-item:last-child { border-bottom: none; }
    .suggestion-item:active { background: var(--bg-tertiary); }
    .suggestion-item .s-icon {
      color: var(--text-tertiary);
      font-size: 14px;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }
    .suggestion-item .s-label { flex: 1; }
    .suggestion-item.recent .s-icon { color: var(--accent); }

    /* ===== Task Summary (Today) ===== */
    .task-summary {
      margin: 0 20px 12px;
    }
    .task-summary-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 6px;
    }
    .task-summary-name {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .task-summary-detail {
      text-align: right;
    }
    .task-summary-time {
      font-size: 15px;
      font-weight: 700;
      color: var(--accent);
    }
    .task-summary-count {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    /* ===== Version ===== */
    .version-tag {
      margin-top: 20px;
      font-size: 10px;
      color: var(--text-tertiary);
      letter-spacing: 1px;
      opacity: 0.4;
    }
  </style>
</head>
<body>

  <!-- Brand Header -->
  <div class="brand-header">
    <div class="brand-name">TRUE NORTH</div>
  </div>

  <!-- Timer Screen -->
  <div id="screen-timer" class="screen active">
    <div class="timer-screen">
      <div id="task-input-area" class="input-wrap">
        <input type="text" id="taskInput" class="task-input" placeholder="What are you working on?" autocomplete="off">
        <div class="suggestions" id="suggestions"></div>
      </div>
      <div id="task-label-area" style="display:none">
        <div class="task-label" id="taskLabel"></div>
      </div>

      <div id="timerDisplay" class="timer-display idle">00:00:00</div>
      <div id="pausedLabel" class="paused-label" style="display:none">Paused</div>

      <div class="controls" id="controls-idle">
        <button class="btn btn-start" id="btnStart" disabled>Start</button>
      </div>
      <div class="controls" id="controls-running" style="display:none">
        <button class="btn btn-pause" id="btnPause">Pause</button>
        <button class="btn btn-stop" id="btnStop1">Stop</button>
      </div>
      <div class="controls" id="controls-paused" style="display:none">
        <button class="btn btn-resume" id="btnResume">Resume</button>
        <button class="btn btn-stop" id="btnStop2">Stop</button>
      </div>

      <div class="daily-banner">
        <span class="label">Total</span>
        <span class="value" id="miniTotal">0m</span>
      </div>
      <div class="version-tag">v8.1</div>
    </div>
  </div>

  <!-- Today Screen -->
  <div id="screen-today" class="screen">
    <div class="today-screen">
      <div class="total-banner-large">
        <span class="label">Total</span>
        <span class="value" id="todayTotal">0m</span>
      </div>
      <div id="todayTaskSummary" class="task-summary"></div>
      <div id="todaySessionCount" class="section-title"></div>
      <div id="todayList"></div>
      <div id="todayEmpty" class="empty-state" style="display:none">
        <div class="icon">◎</div>
        <div class="msg">No sessions yet</div>
        <div class="sub">Start your first session today</div>
      </div>

      <div class="reset-section" id="todayResetSection" style="display:none">
        <button class="btn-reset" onclick="showResetModal('today')">Reset Today</button>
      </div>
    </div>
  </div>

  <!-- History Screen -->
  <div id="screen-history" class="screen">
    <div class="history-screen">
      <div class="stats-toggle">
        <button id="toggleWeek" class="active" onclick="setStatsView('week')">Weekly</button>
        <button id="toggleMonth" onclick="setStatsView('month')">Monthly</button>
      </div>

      <div class="stats-summary">
        <div class="stat-card">
          <div class="stat-label" id="statPeriodLabel">This Week</div>
          <div class="stat-value" id="statTotal">0m</div>
          <div class="stat-sub" id="statDays">0 days</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Daily Avg</div>
          <div class="stat-value" id="statAvg">0m</div>
          <div class="stat-sub" id="statSessions">0 sessions</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title" id="chartTitle">Daily Breakdown</div>
        <div class="chart" id="chartBars"></div>
      </div>

      <div class="history-section-title" id="historyDetailTitle">All Records</div>
      <div id="historyList"></div>
      <div id="historyEmpty" class="empty-state" style="display:none">
        <div class="icon">◎</div>
        <div class="msg">No records yet</div>
        <div class="sub">Your history will appear here</div>
      </div>

      <div class="reset-section" id="historyResetSection" style="display:none">
        <button class="btn-reset" onclick="showResetModal('all')">Reset All Records</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay" id="resetModal">
    <div class="modal">
      <div class="modal-title" id="modalTitle">Reset Data</div>
      <div class="modal-msg" id="modalMsg">This action cannot be undone.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" onclick="closeResetModal()">Cancel</button>
        <button class="modal-btn modal-confirm" id="modalConfirm">Delete</button>
      </div>
    </div>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <button class="tab active" data-screen="timer">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
      </svg>
      Timer
    </button>
    <button class="tab" data-screen="today">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01"/>
      </svg>
      Today
    </button>
    <button class="tab" data-screen="history">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      History
    </button>
  </nav>

  <script>
    // ===== Storage =====
    const KEYS = {
      TIMER: 'study_timer_state',
      daily: (d) => `study_daily_${d}`,
      ALL_DATES: 'study_all_dates',
    };

    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    function load(key) { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } }

    // ===== Time Utils =====
    function pad(n) { return n.toString().padStart(2, '0'); }
    function formatDuration(ms) {
      const s = Math.floor(ms / 1000);
      return `${pad(Math.floor(s / 3600))}:${pad(Math.floor((s % 3600) / 60))}:${pad(s % 60)}`;
    }
    function formatShort(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = totalSeconds % 60;
      if (h > 0) return `${h}h ${m}m`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }
    function formatTime(iso) {
      const d = new Date(iso);
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function todayStr() {
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function formatDateHeader(ds) {
      const d = new Date(ds + 'T00:00:00');
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      return `${months[d.getMonth()]} ${d.getDate()} (${weekdays[d.getDay()]})`;
    }

    // ===== State =====
    const DEFAULT_STATE = { status: 'idle', taskName: '', segmentStartedAt: null, accumulatedMs: 0, sessionStartedAt: null };
    let state = load(KEYS.TIMER) || { ...DEFAULT_STATE };
    let tickInterval = null;

    // ===== DOM =====
    const $ = (id) => document.getElementById(id);
    const taskInput = $('taskInput');
    const taskInputArea = $('task-input-area');
    const taskLabelArea = $('task-label-area');
    const taskLabel = $('taskLabel');
    const timerDisplay = $('timerDisplay');
    const pausedLabel = $('pausedLabel');
    const controlsIdle = $('controls-idle');
    const controlsRunning = $('controls-running');
    const controlsPaused = $('controls-paused');
    const btnStart = $('btnStart');
    const miniTotal = $('miniTotal');

    // ===== Timer Logic =====
    function computeElapsed() {
      if (state.status === 'running' && state.segmentStartedAt) {
        return state.accumulatedMs + (Date.now() - new Date(state.segmentStartedAt).getTime());
      }
      return state.accumulatedMs;
    }

    function persistState() { save(KEYS.TIMER, state); }

    function startTimer() {
      const name = taskInput.value.trim();
      if (!name) return;
      const now = new Date().toISOString();
      state = { status: 'running', taskName: name, segmentStartedAt: now, accumulatedMs: 0, sessionStartedAt: now };
      persistState();
      updateUI();
      startTick();
    }

    function pauseTimer() {
      state.accumulatedMs = computeElapsed();
      state.status = 'paused';
      state.segmentStartedAt = null;
      persistState();
      stopTick();
      updateUI();
    }

    function resumeTimer() {
      state.status = 'running';
      state.segmentStartedAt = new Date().toISOString();
      persistState();
      updateUI();
      startTick();
    }

    function stopTimer() {
      const elapsed = computeElapsed();
      const taskName = state.taskName;
      const sessionStart = state.sessionStartedAt;

      if (elapsed > 0 && sessionStart) {
        const session = {
          id: Date.now().toString(),
          taskName: taskName,
          startedAt: sessionStart,
          endedAt: new Date().toISOString(),
          durationMs: elapsed,
        };
        saveSession(session);
      }

      state = { ...DEFAULT_STATE };
      persistState();
      stopTick();
      taskInput.value = '';
      updateUI();
      updateTodayScreen();
      updateHistoryScreen();
    }

    function startTick() {
      stopTick();
      tickInterval = setInterval(() => {
        timerDisplay.textContent = formatDuration(computeElapsed());
        updateMiniTotal();
      }, 100);
    }

    function stopTick() {
      if (tickInterval) { clearInterval(tickInterval); tickInterval = null; }
    }

    // ===== Session Storage =====
    function localDateStr(isoStr) {
      const d = new Date(isoStr);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function saveSession(session) {
      try {
        const date = localDateStr(session.startedAt);
        const key = KEYS.daily(date);
        const record = load(key) || { date: date, sessions: [], totalDurationMs: 0 };
        record.sessions.push(session);
        record.totalDurationMs += session.durationMs;
        save(key, record);

        const dates = load(KEYS.ALL_DATES) || [];
        if (!dates.includes(date)) {
          dates.push(date);
          dates.sort().reverse();
          save(KEYS.ALL_DATES, dates);
        }
      } catch (e) {
        alert('Save error: ' + e.message);
      }
    }

    function getTodayRecord() {
      return load(KEYS.daily(todayStr())) || { date: todayStr(), sessions: [], totalDurationMs: 0 };
    }

    function deleteSession(date, sessionId) {
      const key = KEYS.daily(date);
      const record = load(key);
      if (!record) return;

      const idx = record.sessions.findIndex(s => s.id === sessionId);
      if (idx === -1) return;

      record.totalDurationMs -= record.sessions[idx].durationMs;
      record.sessions.splice(idx, 1);

      if (record.sessions.length === 0) {
        localStorage.removeItem(key);
        const dates = (load(KEYS.ALL_DATES) || []).filter(d => d !== date);
        save(KEYS.ALL_DATES, dates);
      } else {
        save(key, record);
      }
    }

    // ===== UI Update =====
    function updateUI() {
      if (state.status === 'idle') {
        taskInputArea.style.display = '';
        taskLabelArea.style.display = 'none';
        timerDisplay.className = 'timer-display idle';
        timerDisplay.textContent = '00:00:00';
        pausedLabel.style.display = 'none';
        controlsIdle.style.display = 'flex';
        controlsRunning.style.display = 'none';
        controlsPaused.style.display = 'none';
      } else if (state.status === 'running') {
        taskInputArea.style.display = 'none';
        taskLabelArea.style.display = '';
        taskLabel.textContent = state.taskName;
        timerDisplay.className = 'timer-display running';
        timerDisplay.textContent = formatDuration(computeElapsed());
        pausedLabel.style.display = 'none';
        controlsIdle.style.display = 'none';
        controlsRunning.style.display = 'flex';
        controlsPaused.style.display = 'none';
      } else {
        taskInputArea.style.display = 'none';
        taskLabelArea.style.display = '';
        taskLabel.textContent = state.taskName;
        timerDisplay.className = 'timer-display paused';
        timerDisplay.textContent = formatDuration(computeElapsed());
        pausedLabel.style.display = '';
        controlsIdle.style.display = 'none';
        controlsRunning.style.display = 'none';
        controlsPaused.style.display = 'flex';
      }
      updateMiniTotal();
    }

    function updateMiniTotal() {
      const rec = getTodayRecord();
      let total = rec.totalDurationMs;
      if (state.status !== 'idle') total += computeElapsed();
      miniTotal.textContent = total > 0 ? formatShort(total) : '0m';
    }

    function renderSessionCard(session) {
      const date = localDateStr(session.startedAt);
      return `<div class="session-card" data-id="${session.id}">
        <div class="session-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <div class="session-info">
          <div class="session-name">${session.taskName}</div>
          <div class="session-time">${formatTime(session.startedAt)} – ${formatTime(session.endedAt)}</div>
        </div>
        <div class="session-duration">${formatShort(session.durationMs)}</div>
        <button class="session-delete" onclick="onDeleteSession('${date}','${session.id}')" title="Delete">✕</button>
      </div>`;
    }

    function onDeleteSession(date, sessionId) {
      if (!confirm('Delete this session?')) return;
      deleteSession(date, sessionId);
      updateUI();
      updateTodayScreen();
      updateHistoryScreen();
    }

    function updateTodayScreen() {
      const rec = getTodayRecord();
      let total = rec.totalDurationMs;
      if (state.status !== 'idle') total += computeElapsed();
      $('todayTotal').textContent = total > 0 ? formatShort(total) : '0m';

      const sessions = [...rec.sessions].reverse();
      if (sessions.length === 0) {
        $('todayTaskSummary').innerHTML = '';
        $('todaySessionCount').textContent = '';
        $('todayList').innerHTML = '';
        $('todayEmpty').style.display = '';
        $('todayResetSection').style.display = 'none';
      } else {
        // Task summary — group by name
        const taskMap = {};
        rec.sessions.forEach(s => {
          const key = s.taskName;
          if (!taskMap[key]) taskMap[key] = { totalMs: 0, count: 0 };
          taskMap[key].totalMs += s.durationMs;
          taskMap[key].count++;
        });
        const taskEntries = Object.entries(taskMap).sort((a, b) => b[1].totalMs - a[1].totalMs);

        // Only show summary if more than 1 unique task
        if (taskEntries.length > 1) {
          $('todayTaskSummary').innerHTML = taskEntries.map(([name, data]) =>
            `<div class="task-summary-item">
              <div class="task-summary-name">${name}</div>
              <div class="task-summary-detail">
                <div class="task-summary-time">${formatShort(data.totalMs)}</div>
                <div class="task-summary-count">${data.count} session${data.count > 1 ? 's' : ''}</div>
              </div>
            </div>`
          ).join('');
        } else {
          $('todayTaskSummary').innerHTML = '';
        }

        $('todaySessionCount').textContent = `Sessions (${sessions.length})`;
        $('todayList').innerHTML = sessions.map(renderSessionCard).join('');
        $('todayEmpty').style.display = 'none';
        $('todayResetSection').style.display = '';
      }
    }

    // ===== Stats & Chart =====
    let currentStatsView = 'week';

    function setStatsView(view) {
      currentStatsView = view;
      $('toggleWeek').classList.toggle('active', view === 'week');
      $('toggleMonth').classList.toggle('active', view === 'month');
      updateHistoryScreen();
    }

    function getDateRange(view) {
      const today = new Date();
      const dates = [];
      if (view === 'week') {
        const day = today.getDay();
        const monday = new Date(today);
        monday.setDate(today.getDate() - (day === 0 ? 6 : day - 1));
        for (let i = 0; i < 7; i++) {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          dates.push(formatDateStr(d));
        }
      } else {
        const year = today.getFullYear();
        const month = today.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 1; i <= daysInMonth; i++) {
          dates.push(formatDateStr(new Date(year, month, i)));
        }
      }
      return dates;
    }

    function formatDateStr(d) {
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function getShortLabel(dateStr, view) {
      const d = new Date(dateStr + 'T00:00:00');
      if (view === 'week') {
        return ['S','M','T','W','T','F','S'][d.getDay()];
      }
      return d.getDate().toString();
    }

    function formatHours(ms) {
      const h = ms / 3600000;
      if (h >= 1) return h.toFixed(1) + 'h';
      const m = Math.floor(ms / 60000);
      if (m > 0) return m + 'm';
      return Math.floor(ms / 1000) + 's';
    }

    function updateHistoryScreen() {
      const allDates = load(KEYS.ALL_DATES) || [];
      const rangeDates = getDateRange(currentStatsView);
      const todayDate = todayStr();

      let totalMs = 0;
      let totalSessions = 0;
      let studyDays = 0;
      const dailyData = [];

      for (const date of rangeDates) {
        const rec = load(KEYS.daily(date));
        const ms = rec ? rec.totalDurationMs : 0;
        const sessions = rec ? rec.sessions.length : 0;
        dailyData.push({ date, ms, sessions });
        totalMs += ms;
        totalSessions += sessions;
        if (ms > 0) studyDays++;
      }

      $('statPeriodLabel').textContent = currentStatsView === 'week' ? 'This Week' : 'This Month';
      $('statTotal').textContent = totalMs > 0 ? formatShort(totalMs) : '0m';
      $('statDays').textContent = `${studyDays} days`;
      $('statAvg').textContent = studyDays > 0 ? formatShort(Math.floor(totalMs / studyDays)) : '0m';
      $('statSessions').textContent = `${totalSessions} sessions`;

      // Chart
      const maxMs = Math.max(...dailyData.map(d => d.ms), 1);
      const totalBars = dailyData.length;
      const monthLabels = [1, 7, 14, 21, 28];
      let chartHtml = '';
      for (let i = 0; i < dailyData.length; i++) {
        const d = dailyData[i];
        const heightPct = (d.ms / maxMs) * 100;
        const isToday = d.date === todayDate;
        const valueLabel = d.ms > 0 ? formatHours(d.ms) : '';
        const dayNum = new Date(d.date + 'T00:00:00').getDate();
        const showLabel = totalBars <= 7 || monthLabels.includes(dayNum) || i === totalBars - 1;
        const label = showLabel ? getShortLabel(d.date, currentStatsView) : '';
        chartHtml += `<div class="chart-bar-wrap">
          <div class="chart-bar-value">${valueLabel}</div>
          <div class="chart-bar ${isToday ? 'today-bar' : ''}" style="height: ${Math.max(heightPct, d.ms > 0 ? 3 : 0)}%"></div>
          <div class="chart-bar-label">${label}</div>
        </div>`;
      }
      $('chartBars').innerHTML = chartHtml;
      $('chartTitle').textContent = currentStatsView === 'week' ? 'Daily Breakdown · Week' : 'Daily Breakdown · Month';

      // Records
      if (allDates.length === 0) {
        $('historyList').innerHTML = '';
        $('historyEmpty').style.display = '';
        $('historyDetailTitle').style.display = 'none';
        $('historyResetSection').style.display = 'none';
        return;
      }
      $('historyEmpty').style.display = 'none';
      $('historyDetailTitle').style.display = '';
      $('historyResetSection').style.display = '';
      let html = '';
      for (const date of allDates) {
        const rec = load(KEYS.daily(date));
        if (!rec || rec.sessions.length === 0) continue;
        html += `<div class="date-header">
          <span class="date">${formatDateHeader(date)}</span>
          <span class="total">${formatShort(rec.totalDurationMs)}</span>
        </div>`;
        const sessions = [...rec.sessions].reverse();
        html += sessions.map(renderSessionCard).join('');
      }
      $('historyList').innerHTML = html;
    }

    // ===== Reset Functions =====
    let pendingResetType = null;

    function showResetModal(type) {
      pendingResetType = type;
      if (type === 'today') {
        $('modalTitle').textContent = 'Reset Today';
        $('modalMsg').textContent = 'All sessions from today will be permanently deleted.';
      } else {
        $('modalTitle').textContent = 'Reset All Records';
        $('modalMsg').textContent = 'All records will be permanently deleted. This cannot be undone.';
      }
      $('resetModal').classList.add('show');
    }

    function closeResetModal() {
      $('resetModal').classList.remove('show');
      pendingResetType = null;
    }

    $('modalConfirm').addEventListener('click', () => {
      if (pendingResetType === 'today') {
        const today = todayStr();
        localStorage.removeItem(KEYS.daily(today));
        const dates = (load(KEYS.ALL_DATES) || []).filter(d => d !== today);
        save(KEYS.ALL_DATES, dates);
      } else if (pendingResetType === 'all') {
        const dates = load(KEYS.ALL_DATES) || [];
        for (const d of dates) localStorage.removeItem(KEYS.daily(d));
        localStorage.removeItem(KEYS.ALL_DATES);
      }
      closeResetModal();
      updateUI();
      updateTodayScreen();
      updateHistoryScreen();
    });

    $('resetModal').addEventListener('click', (e) => {
      if (e.target === $('resetModal')) closeResetModal();
    });

    // ===== Tab Navigation =====
    const tabs = document.querySelectorAll('.tab');
    const screens = document.querySelectorAll('.screen');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.screen;
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        screens.forEach(s => s.classList.remove('active'));
        $(`screen-${target}`).classList.add('active');

        if (target === 'today') updateTodayScreen();
        if (target === 'history') updateHistoryScreen();
      });
    });

    // ===== Suggestions Dropdown =====
    const DEFAULT_TAGS = ['Study', 'Exercise', 'Reading', 'Work', 'Meditation', 'Coding'];
    const suggestionsEl = $('suggestions');

    function getRecentTasks() {
      const allDates = load(KEYS.ALL_DATES) || [];
      const tasks = new Set();
      for (const date of allDates.slice(0, 14)) {
        const rec = load(KEYS.daily(date));
        if (rec) rec.sessions.forEach(s => tasks.add(s.taskName));
      }
      return [...tasks];
    }

    function getSuggestions(query) {
      const recent = getRecentTasks();
      const items = [];
      const added = new Set();
      // Recent first
      recent.forEach(t => {
        if (!added.has(t.toLowerCase())) {
          items.push({ name: t, isRecent: true });
          added.add(t.toLowerCase());
        }
      });
      // Then defaults
      DEFAULT_TAGS.forEach(t => {
        if (!added.has(t.toLowerCase())) {
          items.push({ name: t, isRecent: false });
          added.add(t.toLowerCase());
        }
      });
      // Filter by query
      if (query) {
        const q = query.toLowerCase();
        return items.filter(i => i.name.toLowerCase().includes(q));
      }
      return items.slice(0, 8);
    }

    function showSuggestions() {
      const query = taskInput.value.trim();
      const items = getSuggestions(query);
      if (items.length === 0 || (items.length === 1 && items[0].name.toLowerCase() === query.toLowerCase())) {
        suggestionsEl.classList.remove('show');
        return;
      }
      suggestionsEl.innerHTML = items.map(i =>
        `<div class="suggestion-item ${i.isRecent ? 'recent' : ''}" onmousedown="pickSuggestion('${i.name.replace(/'/g, "\\'")}')">
          <span class="s-icon">${i.isRecent ? '↻' : '○'}</span>
          <span class="s-label">${i.name}</span>
        </div>`
      ).join('');
      suggestionsEl.classList.add('show');
    }

    function hideSuggestions() {
      setTimeout(() => suggestionsEl.classList.remove('show'), 150);
    }

    function pickSuggestion(name) {
      taskInput.value = name;
      btnStart.disabled = false;
      suggestionsEl.classList.remove('show');
      taskInput.blur();
    }

    taskInput.addEventListener('focus', showSuggestions);
    taskInput.addEventListener('blur', hideSuggestions);

    // ===== Event Listeners =====
    taskInput.addEventListener('input', () => {
      btnStart.disabled = !taskInput.value.trim();
      showSuggestions();
    });
    taskInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && taskInput.value.trim()) startTimer();
    });
    btnStart.addEventListener('click', startTimer);
    $('btnPause').addEventListener('click', pauseTimer);
    $('btnResume').addEventListener('click', resumeTimer);
    $('btnStop1').addEventListener('click', stopTimer);
    $('btnStop2').addEventListener('click', stopTimer);

    // ===== Visibility Change =====
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && state.status === 'running') {
        timerDisplay.textContent = formatDuration(computeElapsed());
        updateMiniTotal();
      }
    });

    // ===== Init =====
    if (state.status !== 'idle') {
      taskInput.value = state.taskName;
    }
    updateUI();
    if (state.status === 'running') startTick();

    // Remove old service workers
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(regs => {
        regs.forEach(r => r.unregister());
      });
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
  </script>
</body>
</html>
